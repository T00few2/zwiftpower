<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∑Ô∏è Membership Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; margin:0; }
    header { background:#111827; color:#fff; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; }
    .container { padding: 20px; max-width: 1100px; margin: 0 auto; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px; }
    h1 { font-size: 20px; margin: 0; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label { display:block; font-size: 13px; color:#374151; margin-bottom:6px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; border:1px solid #e5e7eb; border-radius:8px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .switch { display:flex; align-items:center; gap:8px; }
    .btn { background:#111827; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .btn.secondary { background:#6b7280; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    select { width: 100%; padding: 8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #f0f0f0; font-size: 13px; text-align:left; }
    th { background:#f9fafb; font-weight:600; }
    .actions { display:flex; gap:8px; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <header>
    <h1>Membership Admin</h1>
    <div class="actions">
      <a href="/dashboard" class="btn secondary">Dashboard</a>
    </div>
  </header>
  <div class="container">
    <div class="card">
      <h2>Settings</h2>
      <div class="row">
        <div>
          <label>Min amount (DKK)</label>
          <input type="number" id="minAmount" min="1" value="10" />
        </div>
        <div>
          <label>Max amount (DKK)</label>
          <input type="number" id="maxAmount" min="1" value="100" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="switch">
          <input type="checkbox" id="dualYear" checked />
          <label for="dualYear">Dual year mode (cover current + next year)</label>
        </div>
        <div>
          <label>Club Member Role ID (Discord)</label>
          <input type="text" id="roleId" placeholder="e.g. 123456789012345678" />
          <div style="height:8px;"></div>
          <label>Choose existing role</label>
          <div class="actions" style="gap:8px;">
            <select id="roleSelect"></select>
            <button class="btn secondary" id="refreshRolesBtn" type="button">Refresh</button>
          </div>
          <div class="muted" style="margin-top:6px;">Selecting a role fills the Role ID field.</div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="saveSettingsBtn">Save settings</button>
        <span id="settingsStatus" class="muted"></span>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="reconcileBtn" type="button">Reconcile roles now</button>
        <span id="reconcileStatus" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h2>Recent Payments</h2>
      <div class="actions" style="margin-bottom:8px;">
        <button class="btn secondary" id="refreshPaymentsBtn">Refresh</button>
        <span id="paymentsStatus" class="muted"></span>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Paid at</th>
              <th>User ID</th>
              <th>Full name</th>
              <th>Email</th>
              <th>Amount (DKK)</th>
              <th>Years</th>
              <th>Through</th>
              <th>PI</th>
            </tr>
          </thead>
          <tbody id="paymentsTbody">
            <tr><td colspan="8" class="muted">No data</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    let guildRoles = [];

    function syncSelectFromInput() {
      const currentId = ($('#roleId').value || '').trim();
      const sel = $('#roleSelect');
      if (!sel) return;
      const idx = guildRoles.findIndex(r => String(r.id) === String(currentId));
      sel.value = idx >= 0 ? String(currentId) : '';
    }

    function syncInputFromSelect() {
      const sel = $('#roleSelect');
      if (!sel) return;
      const val = sel.value;
      if (val) $('#roleId').value = val;
    }

    async function loadRoles() {
      try {
        const res = await fetch('/api/roles/guild-roles', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load roles');
        const data = await res.json();
        guildRoles = Array.isArray(data.roles) ? data.roles : [];
        const sel = $('#roleSelect');
        if (sel) {
          const opts = ['<option value="">-- Select a role --</option>']
            .concat(guildRoles.map(r => `<option value="${String(r.id)}">${String(r.name || r.id)}</option>`));
          sel.innerHTML = opts.join('');
        }
        syncSelectFromInput();
      } catch (e) {
        console.error(e);
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/membership/settings', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load settings');
        const data = await res.json();
        $('#minAmount').value = data.minAmountDkk ?? 10;
        $('#maxAmount').value = data.maxAmountDkk ?? 100;
        $('#dualYear').checked = !!data.dualYearMode;
        $('#roleId').value = data.clubMemberRoleId || '';
        syncSelectFromInput();
        $('#settingsStatus').textContent = 'Loaded';
        setTimeout(() => $('#settingsStatus').textContent = '', 1200);
      } catch (e) {
        $('#settingsStatus').textContent = e.message || 'Error';
      }
    }

    async function saveSettings() {
      try {
        $('#saveSettingsBtn').disabled = true;
        $('#settingsStatus').textContent = 'Saving...';
        const payload = {
          minAmountDkk: parseInt($('#minAmount').value, 10),
          maxAmountDkk: parseInt($('#maxAmount').value, 10),
          dualYearMode: !!$('#dualYear').checked,
          clubMemberRoleId: ($('#roleId').value || '').trim()
        };
        const res = await fetch('/api/membership/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          throw new Error(j.error || 'Failed to save settings');
        }
        $('#settingsStatus').textContent = 'Saved';
        setTimeout(() => $('#settingsStatus').textContent = '', 1200);
      } catch (e) {
        $('#settingsStatus').textContent = e.message || 'Error';
      } finally {
        $('#saveSettingsBtn').disabled = false;
      }
    }

    function fmt(v) { return v == null ? '' : String(v); }

    async function loadPayments() {
      try {
        $('#paymentsStatus').textContent = 'Loading...';
        const res = await fetch('/api/membership/payments?limit=100', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load payments');
        const data = await res.json();
        const list = Array.isArray(data.payments) ? data.payments : [];
        const tbody = $('#paymentsTbody');
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="8" class="muted">No data</td></tr>';
          $('#paymentsStatus').textContent = 'No payments';
          return;
        }
        tbody.innerHTML = list.map(p => {
          const years = Array.isArray(p.coversYears) ? p.coversYears.join(',') : '';
          const amt = (p.amountDkk != null) ? Number(p.amountDkk).toFixed(2) : '';
          return `<tr>
            <td>${fmt(p.paidAt)}</td>
            <td>${fmt(p.userId)}</td>
            <td>${fmt(p.fullName)}</td>
            <td>${fmt(p.userEmail)}</td>
            <td>${amt}</td>
            <td>${years}</td>
            <td>${fmt(p.coveredThroughYear)}</td>
            <td>${fmt(p.stripe && p.stripe.paymentIntentId)}</td>
          </tr>`;
        }).join('');
        $('#paymentsStatus').textContent = `Loaded ${list.length}`;
        setTimeout(() => $('#paymentsStatus').textContent = '', 1200);
      } catch (e) {
        $('#paymentsStatus').textContent = e.message || 'Error';
      }
    }

    async function reconcileNow() {
      try {
        $('#reconcileBtn').disabled = true;
        $('#reconcileStatus').textContent = 'Reconciling...';
        const res = await fetch('/api/membership/reconcile-roles', { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || 'Reconcile failed');
        }
        $('#reconcileStatus').textContent = `Updated: ${data.updated_memberships || 0}, Added: ${data.roles_added || 0}, Removed: ${data.roles_removed || 0}, Errors: ${data.errors || 0}`;
        setTimeout(() => $('#reconcileStatus').textContent = '', 4000);
      } catch (e) {
        $('#reconcileStatus').textContent = e.message || 'Error';
      } finally {
        $('#reconcileBtn').disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#saveSettingsBtn').addEventListener('click', saveSettings);
      $('#refreshPaymentsBtn').addEventListener('click', loadPayments);
      $('#refreshRolesBtn').addEventListener('click', loadRoles);
      $('#roleSelect').addEventListener('change', syncInputFromSelect);
      $('#reconcileBtn').addEventListener('click', reconcileNow);
      // Load roles first so the select can reflect saved roleId when settings load
      loadRoles().then(loadSettings);
      loadPayments();
    });
  </script>
</body>
</html>


