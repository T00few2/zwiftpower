<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∑Ô∏è Membership Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7fb; margin:0; }
    header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { padding: 24px; max-width: 1200px; margin: 0 auto; }
    .card { background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08); padding:18px; margin-bottom:18px; }
    h1 { font-size: 20px; margin: 0; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label { display:block; font-size: 13px; color:#374151; margin-bottom:6px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 8px; border:1px solid #e5e7eb; border-radius:8px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .switch { display:flex; align-items:center; gap:8px; }
    .btn { background:#667eea; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; }
    .btn.secondary { background:#6b7280; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    select { width: 100%; padding: 8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-bottom:1px solid #f0f0f0; font-size: 13px; text-align:left; }
    th { background:#f9fafb; font-weight:600; }
    .actions { display:flex; gap:8px; }
    .muted { color:#6b7280; }
    .status-badge { padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600; text-transform:uppercase; }
    .status-succeeded { background:#d1fae5; color:#065f46; }
    .status-created, .status-initiated { background:#fef3c7; color:#92400e; }
    .status-failed, .status-terminated { background:#fee2e2; color:#991b1b; }
    .status-authorized, .status-captured { background:#dbeafe; color:#1e40af; }
    .status-unknown { background:#f3f4f6; color:#374151; }
    .filter-bar { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .filter-btn { padding:6px 12px; border-radius:6px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:12px; }
    .filter-btn:hover { background:#f9fafb; }
    .filter-btn.active { background:#667eea; color:#fff; border-color:#667eea; }
    .layout { display:grid; grid-template-columns: 320px 1fr; gap:20px; align-items:start; }
    .sidebar { position: sticky; top: 16px; }
    .section-title { display:flex; align-items:center; gap:8px; font-weight:600; }
    .section-title .badge { background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:12px; font-size:.8em; }
  </style>
</head>
<body>
  <header>
    <h1>Membership Admin</h1>
    <div class="actions">
      <a href="/dashboard" class="btn secondary">Dashboard</a>
    </div>
  </header>
  <div class="container">
    <div class="card" style="margin-top:0;">
      <div class="section-title">
        <span>üè∑Ô∏è</span><span>Membership Administration</span><span class="badge">DZR</span>
      </div>
      <p class="muted" style="margin:8px 0 0 0;">
        Administr√©r medlemskabsindstillinger og se betalinger. V√¶lg den korrekte Discord‚Äërolle til klubmedlemmer,
        s√¶t kontingentets minimum og maksimum, og k√∏r ‚ÄúReconcile‚Äù for at opdatere roller for alle brugere.
      </p>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="card">
          <h2>Settings</h2>
          <div class="row">
            <div>
              <label>Min amount (DKK)</label>
              <input type="number" id="minAmount" min="1" value="10" />
            </div>
            <div>
              <label>Max amount (DKK)</label>
              <input type="number" id="maxAmount" min="1" value="100" />
            </div>
          </div>

          <!-- Removed legacy JSON payment options section -->
          <div class="row" style="margin-top:10px;">
            <div style="grid-column: 1 / -1;">
              <label>V√¶lg Discord‚Äërolle for ‚ÄúClub member‚Äù</label>
              <div class="actions" style="gap:8px;">
                <select id="roleSelect"></select>
                <button class="btn secondary" id="refreshRolesBtn" type="button">Opdater roller</button>
              </div>
              <div class="muted" style="margin-top:6px;">Denne rolle tildeles automatisk ved aktivt klubmedlemskab.</div>
            </div>

            <div style="grid-column: 1 / -1;">
              <label>Tilg√¶ngelige betalingsmuligheder</label>
              <p class="muted" style="margin:0 0 6px 0;">V√¶lg hvilke √•r medlemmer kan betale for.</p>
              <div class="switch"><input type="checkbox" id="poCurrent" /> <label for="poCurrent">Indev√¶rende √•r (<span id="poCurrentLabel"></span>)</label></div>
              <div class="switch"><input type="checkbox" id="poNext" /> <label for="poNext">N√¶ste √•r (<span id="poNextLabel"></span>)</label></div>
              <div class="switch"><input type="checkbox" id="poCurrentNext" /> <label for="poCurrentNext">Indev√¶rende + n√¶ste √•r (<span id="poBothLabel"></span>)</label></div>
            </div>
          </div>
          <div class="actions" style="margin-top:12px;">
            <button class="btn" id="saveSettingsBtn">Save settings</button>
            <span id="settingsStatus" class="muted"></span>
          </div>
        </div>

        <div class="card">
          <h2>Reconcile</h2>
          <p class="muted" style="margin:0 0 8px 0;">Opdater Discord‚Äëroller ud fra seneste betalinger for alle brugere.</p>
          <div class="actions">
            <button class="btn" id="reconcileBtn" type="button">Reconcile roles now</button>
            <span id="reconcileStatus" class="muted"></span>
          </div>
        </div>
      </aside>

      <section class="main">
        <div class="card">
          <h2>Payments Overview</h2>
          <div class="filter-bar">
            <button class="filter-btn active" data-status="">All</button>
            <button class="filter-btn" data-status="succeeded">‚úì Succeeded</button>
            <button class="filter-btn" data-status="created">‚è≥ Created</button>
            <button class="filter-btn" data-status="initiated">üîÑ Initiated</button>
            <button class="filter-btn" data-status="failed">‚úó Failed</button>
            <span style="flex:1;"></span>
            <button class="btn secondary" id="refreshPaymentsBtn">Refresh</button>
            <a class="btn" href="/api/membership/payments.csv">Download CSV</a>
          </div>
          <div id="paymentsSummary" class="muted" style="margin-bottom:8px;"></div>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Full name</th>
                  <th>Amount</th>
                  <th>Years</th>
                  <th>Provider</th>
                  <th>Provider State</th>
                  <th>Reference</th>
                  <th>Paid at</th>
                </tr>
              </thead>
              <tbody id="paymentsTbody">
                <tr><td colspan="9" class="muted">No data</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    let guildRoles = [];

    async function loadRoles() {
      try {
        const res = await fetch('/api/roles/guild-roles', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load roles');
        const data = await res.json();
        guildRoles = Array.isArray(data.roles) ? data.roles : [];
        const sel = $('#roleSelect');
        if (sel) {
          const opts = ['<option value="">-- Select a role --</option>']
            .concat(guildRoles.map(r => `<option value="${String(r.id)}">${String(r.name || r.id)}</option>`));
          sel.innerHTML = opts.join('');
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/membership/settings', { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load settings');
        const data = await res.json();
        const nowY = new Date().getUTCFullYear();
        $('#poCurrentLabel').textContent = String(nowY);
        $('#poNextLabel').textContent = String(nowY + 1);
        $('#poBothLabel').textContent = `${nowY}/${nowY + 1}`;

        $('#minAmount').value = data.minAmountDkk ?? 10;
        $('#maxAmount').value = data.maxAmountDkk ?? 100;
        // Set select to saved role if present
        const sel = $('#roleSelect');
        if (sel) {
          const saved = data.clubMemberRoleId || '';
          sel.value = saved;
          // If role not in list (e.g., permissions), keep blank
          if (saved && sel.value !== saved) {
            const opt = document.createElement('option');
            opt.value = saved;
            opt.textContent = saved;
            sel.appendChild(opt);
            sel.value = saved;
          }
        }
        // Reflect payment options into toggles
        const po = Array.isArray(data.paymentOptions) ? data.paymentOptions : [];
        const hasExactYears = (arr, years) => {
          if (!Array.isArray(arr)) return false;
          const a = [...arr].sort().join(',');
          const b = [...years].sort().join(',');
          return a === b;
        };
        $('#poCurrent').checked = po.some(o => hasExactYears(o.coversYears, [nowY]));
        $('#poNext').checked = po.some(o => hasExactYears(o.coversYears, [nowY + 1]));
        $('#poCurrentNext').checked = po.some(o => hasExactYears(o.coversYears, [nowY, nowY + 1]));
        $('#settingsStatus').textContent = 'Loaded';
        setTimeout(() => $('#settingsStatus').textContent = '', 1200);
      } catch (e) {
        $('#settingsStatus').textContent = e.message || 'Error';
      }
    }

    async function saveSettings() {
      try {
        $('#saveSettingsBtn').disabled = true;
        $('#settingsStatus').textContent = 'Saving...';
        const nowY = new Date().getUTCFullYear();
        const paymentOptions = [];
        if ($('#poCurrent').checked) paymentOptions.push({ id: 'current', label: String(nowY), coversYears: [nowY] });
        if ($('#poNext').checked) paymentOptions.push({ id: 'next', label: String(nowY + 1), coversYears: [nowY + 1] });
        if ($('#poCurrentNext').checked) paymentOptions.push({ id: 'current-next', label: `${nowY}/${nowY + 1}`, coversYears: [nowY, nowY + 1] });
        const payload = {
          minAmountDkk: parseInt($('#minAmount').value, 10),
          maxAmountDkk: parseInt($('#maxAmount').value, 10),
          clubMemberRoleId: ($('#roleSelect').value || '').trim(),
          paymentOptions
        };
        const res = await fetch('/api/membership/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const j = await res.json().catch(() => ({}));
          throw new Error(j.error || 'Failed to save settings');
        }
        $('#settingsStatus').textContent = 'Saved';
        setTimeout(() => $('#settingsStatus').textContent = '', 1200);
      } catch (e) {
        $('#settingsStatus').textContent = e.message || 'Error';
      } finally {
        $('#saveSettingsBtn').disabled = false;
      }
    }

    function fmt(v) { return v == null ? '' : String(v); }
    
    function formatDateTime(isoStr) {
      if (!isoStr) return '';
      try {
        const d = new Date(isoStr);
        return d.toLocaleString('da-DK', { dateStyle: 'short', timeStyle: 'short' });
      } catch { return isoStr; }
    }
    
    function getStatusClass(status) {
      const s = (status || '').toLowerCase();
      if (s === 'succeeded') return 'status-succeeded';
      if (s === 'created') return 'status-created';
      if (s === 'initiated') return 'status-initiated';
      if (s === 'failed' || s === 'terminated') return 'status-failed';
      if (s === 'authorized' || s === 'captured') return 'status-authorized';
      return 'status-unknown';
    }

    let currentFilter = '';
    
    async function loadPayments(statusFilter = '') {
      try {
        currentFilter = statusFilter;
        const url = statusFilter 
          ? `/api/membership/payments?limit=200&status=${encodeURIComponent(statusFilter)}`
          : '/api/membership/payments?limit=200';
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load payments');
        const data = await res.json();
        const list = Array.isArray(data.payments) ? data.payments : [];
        const tbody = $('#paymentsTbody');
        
        // Summary stats
        const succeeded = list.filter(p => (p.status||'').toLowerCase() === 'succeeded').length;
        const pending = list.filter(p => ['created','initiated'].includes((p.status||'').toLowerCase())).length;
        const failed = list.filter(p => ['failed','terminated'].includes((p.status||'').toLowerCase())).length;
        $('#paymentsSummary').innerHTML = `
          <strong>${list.length}</strong> payments shown &nbsp;|&nbsp; 
          <span style="color:#065f46;">‚úì ${succeeded} succeeded</span> &nbsp;|&nbsp;
          <span style="color:#92400e;">‚è≥ ${pending} pending</span> &nbsp;|&nbsp;
          <span style="color:#991b1b;">‚úó ${failed} failed</span>
        `;
        
        if (!list.length) {
          tbody.innerHTML = '<tr><td colspan="9" class="muted">No payments found</td></tr>';
          return;
        }
        tbody.innerHTML = list.map(p => {
          const years = Array.isArray(p.coversYears) ? p.coversYears.join(', ') : '';
          const amt = (p.amountDkk != null) ? Number(p.amountDkk).toFixed(0) + ' DKK' : '';
          const provider = fmt(p.provider || p.paymentProvider || '');
          const providerState = fmt(p.providerState || '');
          const providerRef = fmt(p.providerRef || '');
          const status = fmt(p.status || '');
          const statusClass = getStatusClass(status);
          return `<tr>
            <td>${formatDateTime(p.createdAt)}</td>
            <td><span class="status-badge ${statusClass}">${status || 'unknown'}</span></td>
            <td title="${fmt(p.userEmail)}">${fmt(p.fullName)}</td>
            <td>${amt}</td>
            <td>${years}</td>
            <td>${provider}</td>
            <td><span class="status-badge ${getStatusClass(providerState)}">${providerState || '-'}</span></td>
            <td title="${providerRef}" style="max-width:120px;overflow:hidden;text-overflow:ellipsis;">${providerRef.slice(-20)}</td>
            <td>${formatDateTime(p.paidAt)}</td>
          </tr>`;
        }).join('');
      } catch (e) {
        $('#paymentsSummary').textContent = e.message || 'Error loading payments';
      }
    }
    
    function setupFilterButtons() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadPayments(btn.dataset.status || '');
        });
      });
    }

    async function reconcileNow() {
      try {
        $('#reconcileBtn').disabled = true;
        $('#reconcileStatus').textContent = 'Reconciling...';
        const res = await fetch('/api/membership/reconcile-roles', { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.error || 'Reconcile failed');
        }
        $('#reconcileStatus').textContent = `Updated: ${data.updated_memberships || 0}, Added: ${data.roles_added || 0}, Removed: ${data.roles_removed || 0}, Errors: ${data.errors || 0}`;
        setTimeout(() => $('#reconcileStatus').textContent = '', 4000);
      } catch (e) {
        $('#reconcileStatus').textContent = e.message || 'Error';
      } finally {
        $('#reconcileBtn').disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#saveSettingsBtn').addEventListener('click', saveSettings);
      $('#refreshPaymentsBtn').addEventListener('click', () => loadPayments(currentFilter));
      $('#refreshRolesBtn').addEventListener('click', loadRoles);
      $('#reconcileBtn').addEventListener('click', reconcileNow);
      setupFilterButtons();
      // Load roles first so the select can reflect saved roleId when settings load
      loadRoles().then(loadSettings);
      loadPayments();
    });
  </script>
</body>
</html>


